
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CinemaVerse | Pranav Satav</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- HLS.js for Live TV -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            display: ['Space Grotesk', 'sans-serif'],
            mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'monospace'],
          },
          colors: {
            paper: '#F4F4F0',
            ink: '#1A1A1A',
            'ink-light': '#6B7280',
            brand: {
              primary: '#FF3B30',
              blue: '#0066CC',
              manga: '#FF003C' // Intense red for manga style
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.6s ease-out',
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          },
        }
      }
    }
  </script>

  <style>
    /* UTILITIES */
    * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
    *::-webkit-scrollbar { display: none !important; width: 0 !important; }
    body { -webkit-tap-highlight-color: transparent; background-color: #F4F4F0; overflow: hidden; }
    
    .custom-scrollbar { scrollbar-width: thin !important; }
    .custom-scrollbar::-webkit-scrollbar { display: block !important; width: 4px !important; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    /* Ranked Numbers */
    .rank-number {
        -webkit-text-stroke: 1px #9CA3AF;
        color: transparent;
    }
    .group:hover .rank-number {
        -webkit-text-stroke: 1px #1A1A1A;
        color: #1A1A1A;
    }

    /* Loader */
    .loader {
        border-top-color: transparent;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Hero Background Container */
    .video-bg-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
    }
    
    /* Smooth Tab Transitions */
    .app-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-out;
        opacity: 0;
        pointer-events: none;
        transform: scale(0.98);
        z-index: 0;
    }
    .app-screen.active {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
        z-index: 10;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "hls.js": "https://aistudiocdn.com/hls.js@^1.6.15"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="text-ink min-h-screen overflow-hidden font-sans selection:bg-brand-primary selection:text-white">

  <!-- =========================== -->
  <!-- FLOATING NAV SWITCHER (Global) -->
  <!-- =========================== -->
  <div id="global-nav" class="fixed bottom-6 left-6 z-[60] flex gap-2">
      <button onclick="switchMainTab('hub')" id="nav-hub" class="nav-pill active bg-ink text-white shadow-xl px-5 py-3 rounded-full font-bold text-xs flex items-center gap-2 hover:scale-105 transition-all">
          <i class="fas fa-home"></i> <span>Hub</span>
      </button>
      <button onclick="switchMainTab('live')" id="nav-live" class="nav-pill bg-white text-ink shadow-xl border border-gray-200 px-5 py-3 rounded-full font-bold text-xs flex items-center gap-2 hover:scale-105 transition-all">
          <i class="fas fa-satellite-dish"></i> <span>Live TV</span>
      </button>
  </div>

  <!-- =========================== -->
  <!-- TAB 1: THE HUB (Profile/Stream) -->
  <!-- =========================== -->
  <div id="tab-hub" class="app-screen active flex flex-col md:flex-row">
      
      <!-- White Sidebar -->
      <aside class="w-full md:w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 z-40 h-auto md:h-screen sticky top-0">
          <!-- Profile Header -->
          <div class="p-4 md:p-6 flex items-center gap-4">
              <div class="w-12 h-12 bg-black text-white rounded-xl flex items-center justify-center font-bold text-xl shadow-lg shadow-black/20">
                  <i class="fas fa-infinity"></i>
              </div>
              <div>
                  <h2 class="font-bold text-ink leading-tight font-display text-lg">CinemaVerse</h2>
                  <p class="text-xs text-brand-blue font-bold tracking-wider">ULTIMATE v2</p>
              </div>
          </div>

          <!-- Nav Menu -->
          <nav class="flex-1 px-4 py-2 space-y-1 overflow-x-auto md:overflow-visible flex md:flex-col gap-2 md:gap-0 scrollbar-hide">
              <button onclick="switchSubTab('stream')" class="sub-tab-btn active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-bold bg-paper text-ink border border-gray-200 whitespace-nowrap">
                  <i class="fas fa-play-circle text-lg w-6"></i> Streaming
              </button>
              <button onclick="switchSubTab('cloud')" class="sub-tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium text-gray-500 hover:bg-gray-50 whitespace-nowrap">
                  <i class="fas fa-gamepad text-lg w-6"></i> Cloud Gaming
              </button>
              <button onclick="switchSubTab('settings')" class="sub-tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium text-gray-500 hover:bg-gray-50 whitespace-nowrap">
                  <i class="fas fa-cog text-lg w-6"></i> Settings
              </button>
          </nav>
      </aside>

      <!-- Main Hub Content -->
      <main class="flex-1 h-[calc(100vh-80px)] md:h-screen overflow-y-auto bg-paper relative scroll-smooth outline-none" id="hub-scroll-area" tabindex="-1">
          
          <!-- Sticky Search Bar (Hidden by default, shown via JS only for Stream tab) -->
          <div id="hub-search-container" class="hidden fixed top-4 right-4 md:top-6 md:right-6 z-50 transition-all duration-300">
               <div class="relative group shadow-xl rounded-full">
                  <input type="text" id="movieSearch" placeholder="Search..." class="bg-white/90 backdrop-blur-md border border-gray-200 rounded-full pl-10 pr-4 py-2 md:py-3 text-sm focus:ring-2 focus:ring-ink focus:outline-none w-28 md:w-72 focus:w-48 md:focus:w-80 transition-all shadow-sm">
                  <i class="fas fa-search absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-gray-500 text-xs md:text-sm"></i>
              </div>
          </div>

          <!-- SUB-TAB: STREAMING -->
          <div id="view-stream" class="sub-view pb-32">
              
              <!-- Hero Section -->
              <div class="relative w-full h-[60vh] md:h-[70vh] mb-8 group overflow-hidden bg-black">
                  <div id="hero-bg" class="video-bg-container">
                       <!-- Images injected here via JS -->
                  </div>
                  
                  <!-- Dark Gradients for Text Readability -->
                  <div class="absolute inset-0 bg-gradient-to-t from-[#1A1A1A] via-transparent to-transparent z-10 pointer-events-none"></div>
                  <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/20 to-transparent z-10 pointer-events-none"></div>

                  <!-- Content -->
                  <div class="absolute bottom-0 left-0 right-0 p-6 md:p-16 max-w-[1600px] mx-auto z-20 pointer-events-none">
                      <div id="hero-content" class="animate-slide-up pointer-events-auto">
                          <!-- Content injected via JS -->
                      </div>
                  </div>
              </div>

              <!-- Content Container -->
              <div class="px-6 md:px-10 max-w-[1600px] mx-auto">
                  <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                      <!-- Left Sidebar (Rankings) -->
                      <div class="lg:col-span-4 space-y-8">
                          <div>
                              <h3 class="font-bold text-ink mb-4 text-lg border-b border-gray-200 pb-2">Top Rated This Week</h3>
                              <div id="ranked-list" class="space-y-2"></div>
                          </div>
                          
                          <!-- Quick Filters -->
                          <div>
                               <h3 class="font-bold text-ink mb-4 text-sm uppercase tracking-wide opacity-50">Library</h3>
                               <div class="space-y-1">
                                   <button onclick="renderGrid('continue')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white hover:shadow-sm transition-all flex justify-between items-center group">
                                       <span class="font-medium text-sm text-gray-600 group-hover:text-ink">Continue Watching</span>
                                       <i class="fas fa-history text-xs text-gray-400"></i>
                                   </button>
                                   <button onclick="renderGrid('bookmarks')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white hover:shadow-sm transition-all flex justify-between items-center group">
                                       <span class="font-medium text-sm text-gray-600 group-hover:text-ink">My List</span>
                                       <i class="fas fa-bookmark text-xs text-gray-400"></i>
                                   </button>
                               </div>
                          </div>
                      </div>

                      <!-- Right Main (Grid) -->
                      <div class="lg:col-span-8">
                          <div class="flex items-center justify-between mb-6">
                              <h3 id="grid-title" class="font-bold text-ink text-xl">Popular Updates</h3>
                              <div class="flex gap-2">
                                  <button id="btn-movie" onclick="loadAPI('movie')" class="text-xs font-bold px-3 py-1 rounded-full bg-ink text-white border border-transparent shadow-md transition-all">Movies</button>
                                  <button id="btn-tv" onclick="loadAPI('tv')" class="text-xs font-bold px-3 py-1 rounded-full bg-white text-gray-500 border border-gray-200 hover:text-ink hover:shadow-sm transition-all">TV Shows</button>
                              </div>
                          </div>
                          <div id="main-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-8">
                              <!-- Grid Items -->
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- SUB-TAB: CLOUD GAMING (White Theme Redesign) -->
          <div id="view-cloud" class="sub-view hidden w-full min-h-full bg-[#F4F4F0] text-ink pb-32">
              <div class="max-w-[1600px] mx-auto p-6 md:p-12 flex flex-col xl:flex-row gap-12 h-full">
                  
                  <!-- Left Column: Educational Info -->
                  <div class="flex-1 flex flex-col justify-center space-y-8 animate-fade-in">
                      <div>
                          <div class="text-xs font-bold text-brand-blue mb-6 flex items-center gap-2 uppercase tracking-widest">
                             <i class="fas fa-server"></i> Remote Workstation
                          </div>
                          <h1 class="text-5xl md:text-7xl font-display font-bold text-ink mb-6 leading-tight">
                              Cloud Gaming <br>
                              <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-blue to-cyan-500">Portal</span>
                          </h1>
                          
                          <div class="prose max-w-none mb-8">
                              <p class="text-xl text-gray-600">
                                  Access your personal high-performance gaming rig from anywhere. 
                                  Powered by a dedicated Mini PC running Moonlight/Sunshine, tunneled securely via Cloudflare.
                              </p>
                          </div>

                          <ul class="space-y-4 text-lg">
                              <li class="flex items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all">
                                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0">
                                      <i class="fas fa-microchip text-brand-blue"></i>
                                  </div>
                                  <div>
                                      <div class="font-bold text-ink">Dedicated Hardware</div>
                                      <div class="text-sm text-gray-500">Running 24/7 on local Mini PC</div>
                                  </div>
                              </li>
                              <li class="flex items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all">
                                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0">
                                      <i class="fas fa-shield-alt text-brand-blue"></i>
                                  </div>
                                  <div>
                                      <div class="font-bold text-ink">Secure Tunneling</div>
                                      <div class="text-sm text-gray-500">Protected via Cloudflare Zero Trust</div>
                                  </div>
                              </li>
                              <li class="flex items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all">
                                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0">
                                      <i class="fas fa-bolt text-brand-blue"></i>
                                  </div>
                                  <div>
                                      <div class="font-bold text-ink">Low Latency</div>
                                      <div class="text-sm text-gray-500">Optimized for real-time streaming</div>
                                  </div>
                              </li>
                          </ul>
                      </div>
                  </div>

                  <!-- Right Column: Status & Action -->
                  <div class="flex-1 xl:max-w-xl flex flex-col gap-6 animate-slide-up">
                      
                      <!-- Main Portal Card -->
                      <div class="bg-white border border-gray-200 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                          <!-- Glow effect -->
                          <div class="absolute -top-20 -right-20 w-64 h-64 bg-blue-100/50 blur-[100px] rounded-full pointer-events-none"></div>
                          
                          <div class="flex items-center gap-4 mb-6 relative z-10">
                              <div class="w-12 h-12 bg-gray-50 border border-gray-200 rounded-xl flex items-center justify-center text-ink text-2xl">
                                  <i class="fas fa-gamepad"></i>
                              </div>
                              <div>
                                  <h3 class="font-bold text-ink text-xl">Moonlight Stream</h3>
                                  <p class="text-xs text-gray-400">gaming.pranavsatav.me</p>
                              </div>
                          </div>

                          <!-- Compact Status Box -->
                          <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100 flex items-center justify-between relative z-10">
                               <div class="flex items-center gap-3">
                                   <div id="cloud-status-indicator" class="w-3 h-3 rounded-full bg-gray-300 shadow-sm"></div>
                                   <div>
                                       <div id="cloud-status-text" class="text-sm font-bold text-ink leading-tight">INITIALIZING...</div>
                                       <div id="cloud-status-detail" class="text-[10px] text-gray-500 font-medium">Checking gateway response</div>
                                   </div>
                               </div>
                               <div class="text-xs font-mono text-gray-400">PORT 443</div>
                          </div>

                          <!-- Action Buttons -->
                          <div class="space-y-4 relative z-10">
                              <a id="cloud-launch-btn" href="https://gaming.pranavsatav.me" target="_blank" class="flex items-center justify-center gap-2 w-full bg-ink text-white font-black uppercase text-center py-4 rounded-xl hover:shadow-xl hover:bg-black transition-all transform hover:-translate-y-1 active:scale-95 text-lg tracking-wide">
                                  Launch Portal <i class="fas fa-external-link-alt"></i>
                              </a>
                              
                              <button id="cloud-preview-btn" onclick="toggleCloudIframe()" class="w-full bg-white border border-gray-300 text-ink font-bold uppercase text-center py-3 rounded-xl hover:bg-gray-50 transition-all text-sm">
                                  Try Embedded Mode <i class="fas fa-window-maximize ml-2"></i>
                              </button>
                          </div>
                      </div>

                      <!-- Integrated Network Diagnostics -->
                      <div class="bg-white border border-gray-200 rounded-3xl p-6 shadow-sm">
                           <div class="flex justify-between items-center mb-4">
                               <h3 class="font-bold text-ink text-sm uppercase tracking-wide">Link Integrity</h3>
                               <span id="diag-status" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">IDLE</span>
                           </div>
                           
                           <div class="grid grid-cols-2 gap-4 mb-4">
                               <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                   <div class="text-[10px] uppercase text-gray-400 font-bold mb-1">Latency (Ping)</div>
                                   <div id="net-ping" class="text-2xl font-black text-ink">-- <span class="text-sm font-medium text-gray-400">ms</span></div>
                               </div>
                               <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                   <div class="text-[10px] uppercase text-gray-400 font-bold mb-1">Downstream</div>
                                   <div id="net-speed" class="text-2xl font-black text-ink">-- <span class="text-sm font-medium text-gray-400">Mbps</span></div>
                               </div>
                           </div>

                           <button onclick="runCloudDiagnostics()" id="diag-btn" class="w-full py-3 rounded-xl border border-gray-200 text-xs font-bold text-gray-600 hover:bg-black hover:text-white hover:border-black transition-all flex items-center justify-center gap-2">
                               Run Connectivity Check <i class="fas fa-bolt"></i>
                           </button>
                      </div>

                  </div>

              </div>
              
              <!-- Hidden Iframe Container for "Seamless" integration attempt -->
              <div id="cloud-iframe-container" class="hidden fixed inset-0 z-[100] bg-black">
                  <div class="absolute top-0 left-0 right-0 h-12 bg-zinc-900 flex items-center justify-between px-4 border-b border-white/10">
                      <div class="flex items-center gap-2">
                          <span class="w-2 h-2 rounded-full bg-green-500"></span>
                          <span class="text-white font-bold text-sm">Gaming Portal (Embedded)</span>
                      </div>
                      <button onclick="toggleCloudIframe()" class="text-white hover:text-red-500 transition-colors">
                          <i class="fas fa-times text-xl"></i>
                      </button>
                  </div>
                  <iframe id="cloud-iframe" class="w-full h-full pt-12 border-none" allow="gamepad; fullscreen; autoplay"></iframe>
              </div>
          </div>

          <!-- SUB-TAB: SETTINGS -->
          <div id="view-settings" class="sub-view hidden h-full flex items-center justify-center p-10">
              <div class="text-center">
                  <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-gray-400">
                      <i class="fas fa-tools"></i>
                  </div>
                  <h2 class="text-xl font-bold text-ink">Settings Unavailable</h2>
                  <p class="text-gray-500">This section is under maintenance.</p>
              </div>
          </div>

      </main>
  </div>

  <!-- =========================== -->
  <!-- TAB 2: LIVE TV (List View) -->
  <!-- =========================== -->
  <div id="tab-live" class="app-screen bg-paper flex flex-col overflow-hidden z-50">
      
      <!-- Sticky Header -->
      <div class="shrink-0 bg-white/90 backdrop-blur-md border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm z-40">
           <div class="flex items-center gap-3">
               <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center animate-pulse">
                   <i class="fas fa-broadcast-tower text-red-600"></i>
               </div>
               <div>
                   <h2 class="text-xl font-bold font-display text-ink">Live TV</h2>
                   <p class="text-xs text-gray-500 flex items-center gap-2">
                       <span id="channel-count">0</span> Channels <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                   </p>
               </div>
           </div>
           
           <!-- Search & Filter -->
           <div class="flex flex-1 w-full md:w-auto items-center gap-3 justify-end">
               <div class="relative w-full md:w-64 group">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-ink transition-colors"></i>
                    <input type="text" id="liveSearchInput" placeholder="Find channel..." class="w-full bg-gray-100 border border-gray-200 rounded-full pl-9 pr-4 py-2 text-sm text-ink focus:bg-white focus:ring-2 focus:ring-ink outline-none transition-all">
               </div>
               <select id="liveCategoryFilter" class="bg-gray-100 border border-gray-200 rounded-full px-4 py-2 text-sm text-ink outline-none focus:ring-2 focus:ring-ink cursor-pointer">
                   <option value="All">All Categories</option>
                   <option value="Sports">Sports</option>
                   <option value="News">News</option>
                   <option value="Entertainment">Entertainment</option>
                   <option value="Movies">Movies</option>
                   <option value="Kids">Kids</option>
                   <option value="Music">Music</option>
               </select>
           </div>
      </div>

      <!-- Live Content Area -->
      <div class="flex-1 overflow-y-auto bg-gray-5 relative custom-scrollbar outline-none" id="live-scroll-area" tabindex="-1">
          
          <div class="px-4 md:px-10 max-w-[1400px] mx-auto py-8 pb-32">
              <div id="liveGrid" class="flex flex-col gap-3">
                  <!-- Channels Injected Here -->
                  <div class="py-20 flex flex-col items-center">
                      <div class="w-8 h-8 border-2 border-ink border-t-transparent rounded-full animate-spin mb-4"></div>
                      <span class="text-gray-400 text-xs tracking-widest uppercase">Initializing Satellite Uplink...</span>
                  </div>
              </div>
              <div id="liveLoadMore" class="hidden mt-8 flex justify-center">
                 <button onclick="loadMoreChannels()" class="px-8 py-3 bg-white border border-gray-200 text-ink shadow-lg hover:shadow-xl rounded-full text-sm font-bold transition-all transform hover:-translate-y-1">Load More Channels</button>
              </div>
          </div>
      </div>
  </div>

  <!-- =========================== -->
  <!-- MODALS -->
  <!-- =========================== -->

  <!-- Detail Modal -->
  <div id="detailModal" class="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] relative">
          <button onclick="closeModal('detailModal')" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black"><i class="fas fa-times"></i></button>
          
          <div class="w-full md:w-2/5 h-64 md:h-auto bg-gray-200 relative shrink-0">
              <img id="dm-img" class="w-full h-full object-cover">
              <button onclick="playCurrentMedia()" class="absolute inset-0 flex items-center justify-center bg-black/20 group hover:bg-black/40 transition-all">
                  <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform"><i class="fas fa-play text-xl ml-1"></i></div>
              </button>
          </div>
          
          <div class="p-8 overflow-y-auto flex-1">
              <div class="flex gap-2 mb-4">
                  <span id="dm-type" class="px-2 py-1 bg-black text-white text-[10px] font-bold uppercase rounded">MOVIE</span>
                  <span id="dm-rating" class="px-2 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded"></span>
              </div>
              <h2 id="dm-title" class="text-3xl font-display font-bold text-ink mb-4 leading-none"></h2>
              <p id="dm-desc" class="text-gray-600 text-sm leading-relaxed mb-8"></p>
              
              <div class="flex gap-3">
                  <button onclick="playCurrentMedia()" class="flex-1 bg-ink text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition-all">Watch Now</button>
                  <button onclick="toggleBookmarkCurrent()" id="dm-bookmark" class="px-6 border border-gray-200 rounded-xl hover:bg-gray-50 transition-all"><i class="far fa-bookmark"></i></button>
              </div>
          </div>
      </div>
  </div>

  <!-- Player Modal -->
  <div id="playerModal" class="fixed inset-0 z-[80] bg-black opacity-0 pointer-events-none transition-all duration-300 flex flex-col">
      <div class="bg-zinc-900 border-b border-white/10 p-4 flex justify-between items-center text-white shrink-0">
          <div class="flex items-center gap-4">
              <button onclick="closeModal('playerModal'); stopPlayer();" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
              <h3 id="pm-title" class="font-bold truncate max-w-xs md:max-w-md">Player</h3>
          </div>
          <div id="live-indicator" class="hidden px-2 py-1 bg-red-600 rounded text-xs font-bold animate-pulse">LIVE</div>
      </div>
      
      <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
           <!-- Video Area -->
           <div class="flex-1 relative bg-black flex items-center justify-center w-full h-full">
               <iframe id="videoFrame" class="w-full h-full border-none hidden" allowfullscreen allow="autoplay; encrypted-media"></iframe>
               <video id="hlsPlayer" class="w-full h-full hidden" controls autoplay></video>
           </div>

           <!-- Sidebar for TV Shows (Hidden by default) -->
           <div id="tv-sidebar" class="hidden w-full lg:w-80 bg-zinc-900 border-l border-white/5 flex flex-col h-[40vh] lg:h-full shrink-0 z-20 absolute lg:relative bottom-0 lg:bottom-auto">
                <div class="p-4 border-b border-white/5 shrink-0 flex justify-between items-center bg-zinc-900">
                    <h3 class="text-white text-xs font-bold uppercase tracking-widest">Episodes</h3>
                    <button onclick="document.getElementById('tv-sidebar').classList.add('hidden')" class="lg:hidden text-white"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="p-2 border-b border-white/5 shrink-0 bg-zinc-900">
                    <!-- Layout Fix: flex-wrap to stack seasons -->
                    <div id="season-list" class="flex flex-wrap gap-2 pb-2 max-h-32 overflow-y-auto custom-scrollbar"></div>
                </div>
                <div id="episode-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar bg-zinc-900/90 backdrop-blur-sm"></div>
           </div>
      </div>

      <!-- Controls for Sources (Movies Only) -->
      <div id="server-controls" class="bg-zinc-900 p-4 shrink-0 overflow-x-auto whitespace-nowrap hidden border-t border-white/10">
          <div class="flex items-center gap-4">
              <span class="text-gray-500 text-xs font-bold uppercase">Sources:</span>
              <div id="source-btns" class="inline-flex gap-2"></div>
          </div>
      </div>
  </div>

  <!-- JAVASCRIPT LOGIC -->
  <script>
    // --- STATE ---
    const TMDB_KEY = "6cd21e642140057cd6362bf29f9a33d2";
    let allChannels = [];
    let displayedChannels = [];
    let livePage = 1;
    let bookmarks = JSON.parse(localStorage.getItem('cv_bookmarks') || '[]');
    let history = JSON.parse(localStorage.getItem('cv_history') || '[]');
    let currentMedia = null; 
    let currentType = 'movie'; 
    let currentSeason = 1;
    let currentEpisode = 1;
    let hls = null;
    let trendingItems = [];
    let heroInterval = null;
    let currentHeroIndex = 0;

    // --- INIT ---
    // Use DOMContentLoaded to ensure elements exist before we try to manipulate them
    document.addEventListener('DOMContentLoaded', () => {
        switchMainTab('hub');
        // Explicitly initialize state to hide search bar for non-stream tabs
        switchSubTab('stream'); 
        loadAPI('movie'); // Default
        initSearch();
    });

    // --- NAVIGATION ---
    function switchMainTab(tab) {
        // Toggle Floating Nav Styles
        document.querySelectorAll('.nav-pill').forEach(b => {
            b.classList.remove('bg-ink', 'text-white');
            b.classList.add('bg-white', 'text-ink', 'border');
        });
        const btn = document.getElementById(`nav-${tab}`);
        if(btn) {
            btn.classList.remove('bg-white', 'text-ink', 'border');
            btn.classList.add('bg-ink', 'text-white');
        }

        // Toggle Views with Smooth Transitions
        const hub = document.getElementById('tab-hub');
        const live = document.getElementById('tab-live');

        if(tab === 'hub') {
            hub.classList.add('active');
            live.classList.remove('active');
        } else {
            hub.classList.remove('active');
            live.classList.add('active');
            if(allChannels.length === 0) fetchChannels();
        }
    }

    function switchSubTab(tab) {
        // Sidebar styling
        document.querySelectorAll('.sub-tab-btn').forEach(b => {
            b.classList.remove('active', 'bg-paper', 'text-ink', 'border', 'font-bold');
            b.classList.add('text-gray-500', 'font-medium');
        });
        
        // Find button safely without relying on 'event' which is flaky during initialization
        const activeBtn = document.querySelector(`.sub-tab-btn[onclick*="'${tab}'"]`);
        if(activeBtn) {
            activeBtn.classList.remove('text-gray-500', 'font-medium');
            activeBtn.classList.add('active', 'bg-paper', 'text-ink', 'border', 'font-bold');
        }

        // Content switching
        document.querySelectorAll('.sub-view').forEach(v => v.classList.add('hidden'));
        const view = document.getElementById(`view-${tab}`);
        if(view) view.classList.remove('hidden');

        // Search Bar Visibility Logic
        const searchContainer = document.getElementById('hub-search-container');
        if(searchContainer) {
            if (tab === 'stream') {
                searchContainer.classList.remove('hidden');
            } else {
                searchContainer.classList.add('hidden');
            }
        }

        // Specific Tab Logic
        if(tab === 'cloud') {
            checkCloudServer();
        }
    }

    // --- CLOUD GAMING LOGIC ---
    function checkCloudServer() {
        const statusEl = document.getElementById('cloud-status-text');
        const detailEl = document.getElementById('cloud-status-detail');
        const indicatorEl = document.getElementById('cloud-status-indicator');
        if(!statusEl) return;

        statusEl.textContent = "ATTEMPTING HANDSHAKE";
        detailEl.textContent = "Pinging remote gateway...";
        statusEl.className = "text-sm font-bold text-yellow-600 leading-tight";
        indicatorEl.className = "w-3 h-3 rounded-full bg-yellow-500 animate-pulse shadow-sm";
        
        const setOnline = () => {
            statusEl.textContent = "GATEWAY CONFIRMED";
            detailEl.textContent = "Tunnel Open • Ready for Launch";
            statusEl.className = "text-sm font-bold text-green-600 leading-tight";
            indicatorEl.className = "w-3 h-3 rounded-full bg-green-500 shadow-sm";
        };

        const setOffline = () => {
            statusEl.textContent = "STATUS UNCONFIRMED";
            detailEl.textContent = "Response blocked or Host offline";
            statusEl.className = "text-sm font-bold text-red-500 leading-tight";
            indicatorEl.className = "w-3 h-3 rounded-full bg-red-500 shadow-sm";
        };

        const img = new Image();
        img.onload = setOnline;
        img.onerror = () => {
            fetch("https://gaming.pranavsatav.me", { mode: 'no-cors' })
                .then(() => {
                    // Opaque response, likely online but blocked by CORS or Tunnel page
                    setOnline();
                })
                .catch(setOffline);
        };
        img.src = "https://gaming.pranavsatav.me/favicon.ico?t=" + Date.now();
    }

    function toggleCloudIframe() {
        const container = document.getElementById('cloud-iframe-container');
        const iframe = document.getElementById('cloud-iframe');
        const nav = document.getElementById('global-nav');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            if(!iframe.src) iframe.src = "https://gaming.pranavsatav.me";
            if(nav) nav.classList.add('hidden');
        } else {
            container.classList.add('hidden');
            iframe.src = ""; // Stop processing to save resources
            if(nav) nav.classList.remove('hidden');
        }
    }

    function runCloudDiagnostics() {
        const btn = document.getElementById('diag-btn');
        const status = document.getElementById('diag-status');
        const pingEl = document.getElementById('net-ping');
        const speedEl = document.getElementById('net-speed');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing Link...';
        status.textContent = "RUNNING";
        status.className = "text-[10px] bg-yellow-100 text-yellow-600 px-2 py-1 rounded animate-pulse";
        
        // Simulate Ping
        let p = 0;
        const pingInterval = setInterval(() => {
            p = Math.floor(Math.random() * 40) + 15;
            pingEl.innerHTML = `${p} <span class="text-sm font-medium text-gray-400">ms</span>`;
        }, 100);

        // Simulate Speed
        let s = 0;
        const speedInterval = setInterval(() => {
             s = Math.floor(Math.random() * 500) + 50;
             speedEl.innerHTML = `${s} <span class="text-sm font-medium text-gray-400">Mbps</span>`;
        }, 100);

        setTimeout(() => {
            clearInterval(pingInterval);
            clearInterval(speedInterval);
            
            const finalPing = Math.floor(Math.random() * 10) + 20; // 20-30ms realistic
            const finalSpeed = Math.floor(Math.random() * 200) + 300; // 300-500mbps
            
            pingEl.innerHTML = `${finalPing} <span class="text-sm font-medium text-gray-400">ms</span>`;
            speedEl.innerHTML = `${finalSpeed} <span class="text-sm font-medium text-gray-400">Mbps</span>`;
            
            status.textContent = "OPTIMAL";
            status.className = "text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded";
            
            btn.disabled = false;
            btn.innerHTML = 'Re-Run Connectivity Check <i class="fas fa-redo ml-1"></i>';
        }, 2000);
    }


    // --- STREAMING LOGIC ---
    async function loadAPI(type) {
        currentType = type; // Update global state
        updateTypeButtons(type);
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div class="col-span-full h-40 flex items-center justify-center"><div class="w-8 h-8 border-2 border-ink border-t-transparent rounded-full loader"></div></div>';
        
        try {
            // Fetch Trending
            const res = await fetch(`https://api.themoviedb.org/3/trending/${type}/week?api_key=${TMDB_KEY}`);
            const data = await res.json();
            trendingItems = data.results;

            renderStreamingUI(trendingItems, type);
            startHeroSlideshow(type);

        } catch(e) { console.error(e); }
    }

    function updateTypeButtons(type) {
        const btnMovie = document.getElementById('btn-movie');
        const btnTv = document.getElementById('btn-tv');
        
        // Base classes
        const base = "text-xs font-bold px-3 py-1 rounded-full border transition-all";
        
        // Active/Inactive states
        const active = "bg-ink text-white border-transparent shadow-md";
        const inactive = "bg-white text-gray-500 border-gray-200 hover:text-ink hover:shadow-sm";

        if(type === 'movie') {
            if(btnMovie) btnMovie.className = `${base} ${active}`;
            if(btnTv) btnTv.className = `${base} ${inactive}`;
        } else {
            if(btnMovie) btnMovie.className = `${base} ${inactive}`;
            if(btnTv) btnTv.className = `${base} ${active}`;
        }
    }

    function renderStreamingUI(items, type) {
        // Initial Hero Render
        updateHero(0, type);

        // Ranked List (#1 to #5)
        const ranked = document.getElementById('ranked-list');
        ranked.innerHTML = '';
        items.slice(0, 5).forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = "flex items-center gap-4 group cursor-pointer p-2 rounded-xl hover:bg-white transition-colors border border-transparent hover:border-gray-100";
            row.onclick = () => openDetail(item, type);
            row.innerHTML = `
                <span class="text-4xl font-display font-bold text-gray-300 group-hover:text-ink w-8 text-center rank-number">${idx + 1}</span>
                <img src="https://image.tmdb.org/t/p/w92${item.poster_path}" class="w-12 h-16 object-cover rounded shadow-sm bg-gray-200">
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-sm text-ink truncate">${item.title || item.name}</h4>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] text-gray-500">${(item.release_date || item.first_air_date || '').split('-')[0]}</span>
                        <span class="text-[10px] text-green-600 font-bold">★ ${item.vote_average.toFixed(1)}</span>
                    </div>
                </div>
            `;
            ranked.appendChild(row);
        });

        // Main Grid (Rest)
        renderCards(items.slice(5), type, document.getElementById('main-grid'));
    }

    function startHeroSlideshow(type) {
        if(heroInterval) clearInterval(heroInterval);
        currentHeroIndex = 0;
        heroInterval = setInterval(() => {
            currentHeroIndex = (currentHeroIndex + 1) % 5;
            updateHero(currentHeroIndex, type);
        }, 10000); // 10 seconds
    }

    async function updateHero(index, type) {
        const item = trendingItems[index];
        if(!item) return;

        // Content Update (Text)
        const content = document.getElementById('hero-content');
        // Animation reset
        content.classList.remove('animate-slide-up');
        void content.offsetWidth; 
        content.classList.add('animate-slide-up');

        const isBookmarked = bookmarks.some(b => b.id === item.id);

        // Updated for White Text & Dark Theme Hero
        document.getElementById('hero-content').innerHTML = `
            <span class="inline-block px-3 py-1 bg-white/10 backdrop-blur-md text-white border border-white/20 text-[10px] font-bold uppercase rounded-full w-max mb-4 shadow-sm">
                #${index + 1} Trending
            </span>
            <h2 class="text-4xl md:text-7xl font-display font-bold mb-4 leading-[0.9] text-white drop-shadow-lg">
                ${item.title || item.name}
            </h2>
            <p class="text-gray-200 text-lg md:text-xl font-medium max-w-xl line-clamp-3 mb-8 drop-shadow-md">
                ${item.overview}
            </p>
            <div class="flex gap-4">
                <button onclick="openDetail(trendingItems[${index}], '${type}')" class="px-8 py-4 bg-white text-black font-bold rounded-xl flex items-center gap-2 hover:bg-gray-200 transition-all shadow-lg hover:shadow-xl hover:-translate-y-1">
                    <i class="fas fa-play"></i> Watch Now
                </button>
                <button id="hero-bookmark-btn" onclick="toggleHeroBookmark()" class="w-14 h-14 border border-white/30 rounded-xl flex items-center justify-center transition-colors text-xl shadow-sm ${isBookmarked ? 'bg-white text-black' : 'bg-black/40 text-white backdrop-blur-sm hover:bg-black/60'}">
                     <i class="${isBookmarked ? 'fas' : 'far'} fa-bookmark"></i>
                </button>
            </div>
        `;

        // Hero Background - Smooth Crossfade Logic
        const bgContainer = document.getElementById('hero-bg');
        const newUrl = `https://image.tmdb.org/t/p/original${item.backdrop_path}`;
        
        // Create new image without opacity-60 and mix-blend-multiply
        const newImg = document.createElement('img');
        newImg.src = newUrl;
        newImg.className = "absolute inset-0 w-full h-full object-cover transition-opacity duration-700 ease-in-out opacity-0"; 
        
        bgContainer.appendChild(newImg);

        // Force browser to acknowledge new DOM element before changing opacity
        requestAnimationFrame(() => {
            newImg.classList.remove('opacity-0');
            // Removed opacity-60 reduction, now allows full opacity
        });

        // Cleanup Logic: Identify ALL images that are NOT the new one and remove them
        const oldImages = Array.from(bgContainer.querySelectorAll('img')).filter(img => img !== newImg);
        
        // Remove old images after transition matches duration
        setTimeout(() => {
            oldImages.forEach(img => img.remove());
        }, 700);
    }

    function toggleHeroBookmark() {
        if (!trendingItems[currentHeroIndex]) return;
        const item = trendingItems[currentHeroIndex];
        
        // Add/Remove from bookmarks
        const idx = bookmarks.findIndex(b => b.id === item.id);
        if(idx === -1) {
            bookmarks.push(item);
        } else {
            bookmarks.splice(idx, 1);
        }
        localStorage.setItem('cv_bookmarks', JSON.stringify(bookmarks));

        // Update Button UI - Matching Dark Theme
        const btn = document.getElementById('hero-bookmark-btn');
        const isSaved = bookmarks.some(b => b.id === item.id);
        btn.innerHTML = `<i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i>`;
        btn.className = `w-14 h-14 border border-white/30 rounded-xl flex items-center justify-center transition-colors text-xl shadow-sm ${isSaved ? 'bg-white text-black' : 'bg-black/40 text-white backdrop-blur-sm hover:bg-black/60'}`;

        // If 'My List' is open, refresh it
        if(document.getElementById('grid-title').textContent === "My List") {
             renderGrid('bookmarks');
        }
    }

    function renderCards(items, type, container, isDeletable = false, listName = '') {
        container.innerHTML = '';
        if(items.length === 0) {
            container.innerHTML = `<div class="col-span-full py-10 text-center text-gray-400">Nothing found here.</div>`;
            return;
        }
        items.forEach(item => {
             if(!item.poster_path) return;
             const card = document.createElement('div');
             card.className = "group relative cursor-pointer animate-slide-up";
             
             // Inner content
             const inner = `
                <div class="relative aspect-[2/3] rounded-xl overflow-hidden mb-3 bg-gray-200 shadow-sm transition-all group-hover:shadow-lg group-hover:-translate-y-1">
                    <img src="https://image.tmdb.org/t/p/w342${item.poster_path}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <div class="w-12 h-12 rounded-full bg-white text-ink flex items-center justify-center shadow-lg scale-0 group-hover:scale-100 transition-transform duration-300">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
                <h3 class="font-bold text-sm text-ink truncate">${item.title || item.name}</h3>
                <p class="text-xs text-gray-500">${(item.release_date || item.first_air_date || '').split('-')[0] || 'Unknown'}</p>
             `;
             
             card.innerHTML = inner;
             card.onclick = (e) => {
                 // Ignore clicks on delete button
                 if(e.target.closest('.delete-btn')) return;
                 openDetail(item, item.media_type || type);
             };

             if(isDeletable) {
                 const delBtn = document.createElement('button');
                 delBtn.className = "delete-btn absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors z-20 opacity-0 group-hover:opacity-100";
                 delBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                 delBtn.onclick = (e) => {
                     e.stopPropagation();
                     removeFromList(item.id, listName);
                 };
                 card.firstElementChild.appendChild(delBtn);
             }

             container.appendChild(card);
        });
    }

    function removeFromList(id, listName) {
        if(listName === 'bookmarks') {
            bookmarks = bookmarks.filter(i => i.id !== id);
            localStorage.setItem('cv_bookmarks', JSON.stringify(bookmarks));
            renderGrid('bookmarks');
        } else if (listName === 'continue') {
            history = history.filter(i => i.id !== id);
            localStorage.setItem('cv_history', JSON.stringify(history));
            renderGrid('continue');
        }
    }

    function renderGrid(source) {
        // Switch to grid view
        document.getElementById('grid-title').textContent = source === 'bookmarks' ? "My List" : "Continue Watching";
        const items = source === 'bookmarks' ? bookmarks : history;
        renderCards(items, 'movie', document.getElementById('main-grid'), true, source);
    }

    function initSearch() {
        let debounce;
        const movieSearch = document.getElementById('movieSearch');
        if(movieSearch) {
            movieSearch.addEventListener('input', (e) => {
                clearTimeout(debounce);
                const q = e.target.value;
                
                // Fix: Clear search and revert to popular
                if (q.length === 0) {
                    document.getElementById('grid-title').textContent = "Popular Updates";
                    loadAPI(currentType === 'tv' ? 'tv' : 'movie');
                    return;
                }

                if(q.length > 2) {
                    debounce = setTimeout(() => {
                        document.getElementById('grid-title').textContent = `Search: "${q}"`;
                        fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&query=${encodeURIComponent(q)}`)
                        .then(r=>r.json()).then(d => renderCards(d.results, 'movie', document.getElementById('main-grid')));
                    }, 500);
                }
            });
        }

        // Live Search
        const liveSearch = document.getElementById('liveSearchInput');
        if(liveSearch) {
            liveSearch.addEventListener('input', (e) => {
                renderLiveList(true);
            });
        }
        
        const liveCat = document.getElementById('liveCategoryFilter');
        if(liveCat) {
            liveCat.addEventListener('change', () => {
                renderLiveList(true);
            });
        }
    }

    // --- MODAL & PLAYER ---
    function openDetail(item, type) {
        currentMedia = item;
        currentType = type || (item.name ? 'tv' : 'movie');
        
        document.getElementById('dm-img').src = item.backdrop_path ? `https://image.tmdb.org/t/p/w1280${item.backdrop_path}` : `https://image.tmdb.org/t/p/w500${item.poster_path}`;
        document.getElementById('dm-title').textContent = item.title || item.name;
        document.getElementById('dm-desc').textContent = item.overview || "No description available.";
        document.getElementById('dm-rating').textContent = `${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}/10`;
        document.getElementById('dm-type').textContent = currentType;
        
        // Bookmark State
        updateBookmarkBtn();
        
        // Show
        const m = document.getElementById('detailModal');
        m.classList.remove('opacity-0', 'pointer-events-none');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('opacity-0', 'pointer-events-none');
        if(id === 'detailModal' && heroInterval) {
            // Ensure slideshow continues
        }
        if(id === 'playerModal') {
            stopPlayer(); // Stop audio/video when closing player
        }
        
        // SCROLL FIX: When closing modals, return focus to the scrollable container.
        // This fixes the issue where scroll gets "stuck" because focus is left on hidden elements.
        setTimeout(() => {
             const activeTab = document.getElementById('nav-hub').classList.contains('bg-ink') ? 'hub' : 'live';
             const scrollArea = document.getElementById(activeTab + '-scroll-area');
             if(scrollArea) scrollArea.focus();
        }, 100);
    }

    function addToBookmark(item) {
        if(!item) return;
        const idx = bookmarks.findIndex(b => b.id === item.id);
        if(idx === -1) {
            bookmarks.push(item);
            localStorage.setItem('cv_bookmarks', JSON.stringify(bookmarks));
        }
        if(currentMedia && currentMedia.id === item.id) updateBookmarkBtn();
        else {
             // If currently viewing bookmarks grid, refresh
             if(document.getElementById('grid-title').textContent === "My List") renderGrid('bookmarks');
        }
    }

    function toggleBookmarkCurrent() {
        if(!currentMedia) return;
        const idx = bookmarks.findIndex(b => b.id === currentMedia.id);
        if(idx > -1) bookmarks.splice(idx, 1);
        else bookmarks.push(currentMedia);
        localStorage.setItem('cv_bookmarks', JSON.stringify(bookmarks));
        updateBookmarkBtn();
    }

    function updateBookmarkBtn() {
        const btn = document.getElementById('dm-bookmark');
        const isSaved = bookmarks.some(b => b.id === currentMedia.id);
        btn.innerHTML = `<i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i>`;
        btn.className = `px-6 border border-gray-200 rounded-xl transition-all ${isSaved ? 'bg-ink text-white' : 'hover:bg-gray-50'}`;
    }

    function playCurrentMedia() {
        closeModal('detailModal');
        // Add History
        history = history.filter(h => h.id !== currentMedia.id);
        history.unshift(currentMedia);
        localStorage.setItem('cv_history', JSON.stringify(history));

        // Open Player
        const p = document.getElementById('playerModal');
        p.classList.remove('opacity-0', 'pointer-events-none');
        document.getElementById('pm-title').textContent = currentMedia.title || currentMedia.name;

        // Reset
        document.getElementById('videoFrame').classList.add('hidden');
        document.getElementById('hlsPlayer').classList.add('hidden');
        document.getElementById('server-controls').classList.add('hidden');
        document.getElementById('tv-sidebar').classList.add('hidden');
        document.getElementById('live-indicator').classList.add('hidden');
        if(hls) { hls.destroy(); hls = null; }

        if(currentType === 'live') {
            setupLivePlayer();
        } else {
            if(currentType === 'tv') setupTVPlayer();
            else setupEmbedPlayer();
        }
    }

    async function setupTVPlayer() {
        document.getElementById('tv-sidebar').classList.remove('hidden');
        currentSeason = 1;
        currentEpisode = 1;
        
        // Fetch Seasons
        const res = await fetch(`https://api.themoviedb.org/3/tv/${currentMedia.id}?api_key=${TMDB_KEY}`);
        const data = await res.json();
        
        const sl = document.getElementById('season-list');
        sl.innerHTML = '';
        if(data.seasons) {
            data.seasons.filter(s => s.season_number > 0).forEach(s => {
                const btn = document.createElement('button');
                btn.className = "px-4 py-2 rounded-lg text-sm whitespace-nowrap bg-white/5 hover:bg-white/10 text-gray-300 transition-colors border border-white/5";
                btn.textContent = `Season ${s.season_number}`;
                btn.onclick = () => { 
                    currentSeason = s.season_number; 
                    fetchEpisodes(currentMedia.id, currentSeason); 
                    // Visual active state
                    Array.from(sl.children).forEach(c => c.className = "px-4 py-2 rounded-lg text-sm whitespace-nowrap bg-white/5 text-gray-300 border border-white/5");
                    btn.className = "px-4 py-2 rounded-lg text-sm whitespace-nowrap bg-white text-black font-bold border-transparent";
                };
                sl.appendChild(btn);
            });
            // Click first
            if(sl.firstChild) sl.firstChild.click();
        }
        setupEmbedPlayer();
    }

    async function fetchEpisodes(id, season) {
        const list = document.getElementById('episode-list');
        list.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">Loading...</div>';
        
        const res = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${season}?api_key=${TMDB_KEY}`);
        const data = await res.json();
        
        list.innerHTML = '';
        if(data.episodes) {
            data.episodes.forEach(ep => {
                const row = document.createElement('div');
                row.className = "p-3 rounded-lg hover:bg-white/5 cursor-pointer flex gap-3 group transition-colors mb-2";
                row.onclick = () => {
                    currentEpisode = ep.episode_number;
                    setupEmbedPlayer();
                    // Highlight
                    Array.from(list.children).forEach(c => {
                         c.classList.remove('bg-white/10', 'border-white/10');
                         c.classList.add('hover:bg-white/5');
                    });
                    row.classList.add('bg-white/10');
                    row.classList.remove('hover:bg-white/5');
                };
                
                // Content
                row.innerHTML = `
                    <div class="w-24 h-16 bg-black rounded overflow-hidden shrink-0 relative">
                         ${ep.still_path ? `<img src="https://image.tmdb.org/t/p/w185${ep.still_path}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-gray-700"><i class="fas fa-image"></i></div>'}
                         <div class="absolute bottom-1 right-1 bg-black/80 px-1 rounded text-[8px] text-white">EP ${ep.episode_number}</div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-gray-200 group-hover:text-white truncate">${ep.name}</h4>
                        <p class="text-[10px] text-gray-500 mt-1 line-clamp-2">${ep.overview || 'No description.'}</p>
                    </div>
                `;
                list.appendChild(row);
            });
        }
    }

    function setupEmbedPlayer() {
        const frame = document.getElementById('videoFrame');
        const ctrls = document.getElementById('server-controls');
        frame.classList.remove('hidden');
        ctrls.classList.remove('hidden');

        // Update title for TV
        if(currentType === 'tv') {
             document.getElementById('pm-title').textContent = `${currentMedia.name} - S${currentSeason}:E${currentEpisode}`;
        }

        // Consolidated Server List (New + Original/Standard)
        const servers = [
            // New Reliable Servers
            { name: "VidLink", url: (id) => currentType==='movie' ? `https://vidlink.pro/movie/${id}` : `https://vidlink.pro/tv/${id}/${currentSeason}/${currentEpisode}` },
            { name: "Vidsrc.cc", url: (id) => currentType==='movie' ? `https://vidsrc.cc/v2/embed/movie/${id}` : `https://vidsrc.cc/v2/embed/tv/${id}/${currentSeason}/${currentEpisode}` },
            { name: "EmbedSu", url: (id) => currentType==='movie' ? `https://embed.su/embed/movie/${id}` : `https://embed.su/embed/tv/${id}/${currentSeason}/${currentEpisode}` },
            { name: "SuperEmbed", url: (id) => currentType==='movie' ? `https://multiembed.mov/?video_id=${id}&tmdb=1` : `https://multiembed.mov/?video_id=${id}&tmdb=1&s=${currentSeason}&e=${currentEpisode}` },
            { name: "2Embed", url: (id) => currentType==='movie' ? `https://www.2embed.cc/embed/${id}` : `https://www.2embed.cc/embedtv/${id}&s=${currentSeason}&e=${currentEpisode}` },
            
            // Standard/Original Servers
            { name: "VidSrc.to", url: (id) => currentType==='movie' ? `https://vidsrc.to/embed/movie/${id}` : `https://vidsrc.to/embed/tv/${id}/${currentSeason}/${currentEpisode}` },
            { name: "VidSrc.me", url: (id) => currentType==='movie' ? `https://vidsrc.me/embed/movie?tmdb=${id}` : `https://vidsrc.me/embed/tv?tmdb=${id}&season=${currentSeason}&episode=${currentEpisode}` },
            { name: "Provn", url: (id) => currentType==='movie' ? `https://vidsrc.pro/embed/movie/${id}` : `https://vidsrc.pro/embed/tv/${id}/${currentSeason}/${currentEpisode}` },
            { name: "Smashy", url: (id) => currentType==='movie' ? `https://player.smashy.stream/movie/${id}` : `https://player.smashy.stream/tv/${id}?s=${currentSeason}&e=${currentEpisode}` }
        ];

        const btnContainer = document.getElementById('source-btns');
        btnContainer.innerHTML = '';
        servers.forEach((s, i) => {
            const b = document.createElement('button');
            b.className = `px-3 py-1 rounded text-xs font-bold border transition-colors ${i===0 ? 'bg-white text-black' : 'bg-transparent text-gray-400 hover:text-white border-white/20'}`;
            b.textContent = s.name;
            b.onclick = () => {
                frame.src = s.url(currentMedia.id);
                // Reset styles
                Array.from(btnContainer.children).forEach(c => c.className = 'px-3 py-1 rounded text-xs font-bold border bg-transparent text-gray-400 hover:text-white border-white/20');
                b.className = 'px-3 py-1 rounded text-xs font-bold border bg-white text-black';
            };
            btnContainer.appendChild(b);
        });

        // Load first
        if(!frame.src || frame.src === window.location.href) {
            frame.src = servers[0].url(currentMedia.id);
        }
    }

    function setupLivePlayer() {
        const v = document.getElementById('hlsPlayer');
        v.classList.remove('hidden');
        document.getElementById('live-indicator').classList.remove('hidden');

        if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(currentMedia.url);
            hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PARSED, () => v.play());
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                   switch (data.type) {
                   case Hls.ErrorTypes.NETWORK_ERROR:
                   // try to recover network error
                   hls.startLoad();
                   break;
                   case Hls.ErrorTypes.MEDIA_ERROR:
                   hls.recoverMediaError();
                   break;
                   default:
                   hls.destroy();
                   break;
                   }
                }
            });
        } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
            v.src = currentMedia.url;
            v.play();
        }
    }

    function stopPlayer() {
        const f = document.getElementById('videoFrame');
        f.src = '';
        const v = document.getElementById('hlsPlayer');
        v.pause();
        v.src = '';
        if(hls) hls.destroy();
    }

    // --- LIVE TV LOGIC ---
    async function fetchChannels() {
        let promises = [];
        for(let i=1; i<=13; i++) {
             promises.push(fetch(`https://raw.githubusercontent.com/PranavSatav/pranavsatav.me/main/channels/working${i}.m3u`).then(r => r.ok ? r.text() : null).catch(e=>null));
        }
        
        const results = await Promise.all(promises);
        results.forEach(txt => { if(txt) parseM3U(txt); });
        
        // Enhance Data
        allChannels = allChannels.filter(c => c.url && c.name).map(c => {
             const n = c.name.toLowerCase();
             let cat = 'Entertainment';
             if(n.match(/sport|cricket|football/)) cat = 'Sports';
             else if(n.match(/news|bbc|cnn|aaj tak/)) cat = 'News';
             else if(n.match(/movie|cinema|hbo|star gold/)) cat = 'Movies';
             else if(n.match(/music|mtv/)) cat = 'Music';
             else if(n.match(/kid|cartoon|nick|disney/)) cat = 'Kids';
             
             let logo = c.logo;
             if(!logo || logo.length < 5) {
                 if(n.includes('star')) logo = "https://upload.wikimedia.org/wikipedia/commons/f/f8/Star_India_logo.svg";
                 else if(n.includes('sony')) logo = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Sony_logo.svg/2560px-Sony_logo.svg.png";
                 else if(n.includes('zee')) logo = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Zee_TV_logo.svg/1200px-Zee_TV_logo.svg.png";
             }
             return { ...c, cat, logo };
        });

        document.getElementById('channel-count').textContent = allChannels.length;
        renderLiveList(true);
    }

    function parseM3U(data) {
        const lines = data.split('\n');
        let current = {};
        lines.forEach(line => {
             line = line.trim();
             if(line.startsWith('#EXTINF')) {
                 const logo = line.match(/tvg-logo="([^"]*)"/);
                 const name = line.match(/,(.+)$/);
                 current = { logo: logo ? logo[1] : null, name: name ? name[1].trim() : 'Channel' };
             } else if (line.startsWith('http')) {
                 allChannels.push({ ...current, url: line });
                 current = {};
             }
        });
    }

    function renderLiveList(reset) {
        if(reset) {
            displayedChannels = [];
            livePage = 1;
        }
        const grid = document.getElementById('liveGrid');
        if(reset) grid.innerHTML = '';
        
        const filter = document.getElementById('liveCategoryFilter').value;
        const search = document.getElementById('liveSearchInput').value.toLowerCase();
        
        let filtered = allChannels;
        if(filter !== 'All') filtered = filtered.filter(c => c.cat === filter);
        if(search) filtered = filtered.filter(c => c.name.toLowerCase().includes(search));
        
        const start = (livePage - 1) * 100;
        const end = start + 100;
        const slice = filtered.slice(start, end);
        
        slice.forEach(ch => {
            const el = document.createElement('div');
            el.className = "flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group";
            el.onclick = () => { currentMedia = ch; currentType = 'live'; playCurrentMedia(); };
            
            // Random simulated progress
            const progress = Math.floor(Math.random() * 80) + 10;
            
            el.innerHTML = `
                <div class="w-16 h-12 flex items-center justify-center bg-gray-50 rounded-lg shrink-0 overflow-hidden p-1 border border-gray-100">
                    ${ch.logo ? `<img src="${ch.logo}" class="max-w-full max-h-full object-contain">` : `<span class="font-bold text-gray-400 text-xl">${ch.name[0]}</span>`}
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-ink truncate text-lg group-hover:text-brand-blue">${ch.name}</h4>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 uppercase tracking-wide">HD</span>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                        <p class="text-xs text-gray-500 font-medium truncate">Live Broadcast • ${ch.cat}</p>
                    </div>

                    <!-- Fake Progress Bar -->
                    <div class="w-full h-1 bg-gray-100 rounded-full overflow-hidden mt-2">
                         <div class="h-full bg-brand-blue/60" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-brand-blue group-hover:text-white transition-colors">
                     <i class="fas fa-play ml-1"></i>
                </div>
            `;
            grid.appendChild(el);
        });
        
        const btn = document.getElementById('liveLoadMore');
        if(filtered.length > end) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
    }
    
    window.loadMoreChannels = () => {
        livePage++;
        renderLiveList(false);
    }
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
